<!DOCTYPE html>
<html lang="en">
<head>
<div style="background: url(ressources/Logo_BGE.jpg); 
            background-repeat: no-repeat; 
            background-position: 1000px 20px; 
            background-size: 700px auto;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.2">
    <title>Library Curation Tool</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input[type="text"], select {
            width: 130px;
            padding: 8px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 10px;
            margin-right: 10px;
            color: black;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        .message-container {
            height: 20px; /* Reserve space so no jumping happens */
            text-align: center;
            margin-bottom: 10px;
        }

        .error-message, .success-message {
            display: none; /* Hidden by default */
            padding: 5px;
            font-weight: bold;
            border-radius: 5px;
            text-align: center;
        }

        .success-message {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        .error-message {
            background-color: #F44336; /* Red */
            color: white;
        }
        #logo {
            width: 200px;
            height: auto;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
        }
        .checkbox-group label {
            margin-right: 20px;
        }
        .server-control {
            margin-top: 20px;
        }
       .low-value {
            background-color: #f8d7da; /* red for low values */
            color: #721c24;
        }

        .medium-value {
            background-color: #fff3cd; /* yellow for average values */
            color: #856404;
        }

        .high-value {
            background-color: #d4edda; /* green for high values */
            color: #155724;
        }
        .valid-status {
            background-color: #d4edda;
            color: #155724;
        }

        .synonym-status {
            background-color: #f8d7da;
            color: #721c24;
        }
        .red-row {
            background-color: #f8d7da;
            color: #721c24;
        }

        .green-row {
            background-color: #d4edda;
            color: #155724;
        }
        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Adjust column size */
            gap: 10px; /* Add spacing between items */
            max-width: 1800px; /* Adjust max width */
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between checkbox and label */
        }
        #toggleInvalidButton { 
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease; 
        }

        #toggleInvalidButton.showing {
            background-color: #28a745;  /* Green for "Show Invalid Records" */
            color: black;
        }

        #toggleInvalidButton.hiding {
            background-color: #dc3545;  /* Red for "Hide Invalid Records" */
            color: black;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            font-size: 14px;            
        }                    
        table.dataTable thead .sorting:after,
        table.dataTable thead .sorting_asc:after,
        table.dataTable thead .sorting_desc:after {
            display: none !important;
        }      
    </style>
</head>
<body>
    <img src="ressources/IBOL_LOGO_TRANSPARENT.png" alt="IBOL Logo" id="logo">
    <h1>Library Curation Tool</h1>

    <h2>Filter</h2>
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        
        <div id="infoField" style="display: none; background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-top: 10px;">
            <strong>How to use the filter function:</strong>
            <ul>
                <li>Enter a value in the <b>Search Term</b> field.</li>
                <li>Check a box with the <b>Search Type</b> you wish in <b>Select Columns to Display:</b> to make it available in <b>Search Type</b> dropdown menu.
                <li>Select a corresponding <b>Search Type</b> from the dropdown menu.</li>
                <li>If needed, you can use <b>Search Term 2</b> and its corresponding <b>Search Type</b> to add an additional filter.</li>
                <li>Click <b>Apply Filter</b> to display results matching your criteria.</li>
            </ul>
        </div>
    </div>   
    <form id="filterForm">
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="searchTerm">Search Term 1:</label>
            <input type="text" id="searchTerm" name="searchTerm" required>
            <label for="searchType">Search Type 1:</label>
            <select id="searchType" name="searchType">                                              
            </select>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <label for="searchTerm2">Search Term 2:</label>
            <input type="text" id="searchTerm2" name="searchTerm2" required>
            <label for="searchType2">Search Type 2:</label>
            <select id="searchType2" name="searchType2">                            
            </select>
            <span style="cursor: pointer;" onclick="toggleInfo('infoField')">❓</span>
        </div>
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">        
        <div id="buttonsInfo" style="display: none; background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-top: 10px;">
            <strong>Explanation of Buttons:</strong>
            <ul>
                <li><b>Apply Filter:</b> Filters the records based on your selected criteria and displays the results. / Refreshs the HTML-table</li>
                <li><b>Show/Hide Invalid Records:</b> Toggles the visibility of rows marked with a red background (Status = invalid record or exclude species).</li>
                <li><b>Load Dataset:</b> To load datasets: Select one from the dropdown, click 'Load dataset', confirm the popup with 'OK', then click 'Apply Filter' to view the new dataset.</li>                
                <li><b>Stop Curation Tool:</b> Stops the server running in the backend. Use this only if you want to end the Library Curation Tool.</li>
                <li><b>Export CSV:</b> Export the database as a CSV file. Selected columns (in Select Columns to Display) will be included; if none are selected, all columns will be exported.</li>
            </ul>            
        </div>
    </div>
        <div class="server-control">
        <form id="serverControlForm">            
            <button type="button" onclick="applyFilter()" style="background-color: lightyellow; color: black;">Apply Filter</button>
            <button id="toggleInvalidButton" onclick="toggleInvalidRecords()" class="hiding">Show Invalid Records</button>            
            <select id="dataset-selector"></select>
            <button onclick="switchDataset()">Load Dataset</button>
            <button type="button" onclick="stopServer()" style="background-color: #EE6A50; color: black;">Stop Curation Tool</button>
            <button onclick="downloadCSV()" style="background-color: lightgreen;">Export CSV</button>
            <span style="cursor: pointer;" onclick="toggleInfo('buttonsInfo')">❓</span>
    </form>
    <script>
    function downloadCSV() {
        const selectedColumns = Array.from(document.querySelectorAll('input[name="columns"]:checked'))
            .map(cb => cb.value);

        fetch('/download-csv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ columns: selectedColumns })
        })
        .then(response => response.blob())
        .then(blob => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'taxonomic_records.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        })
        .catch(err => {
            alert('Download failed.');
            console.error(err);
        });
    }
    </script> 
    <script>
        function toggleInfo(infoId) {
            const infoField = document.getElementById(infoId);
            if (infoField.style.display === 'none' || infoField.style.display === '') {
                infoField.style.display = 'block';
            } else {
                infoField.style.display = 'none';
            }
        }
    </script>   
            <div id="distinctValueDisplay" style="font-size: 18px; margin-bottom: 10px; font-weight: bold;">
             <!-- show number of different BINs -->
            </div>
        </div>
        <div class="message-container">
            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>
        </div>
        <b>Statistics</b>
        <div id="statisticsBox" class="stats-grid">
            <div><b>Total: <span id="totalCount">0</span></b></div>
            <div><b>Filtered: <span id="recordCount">0</span></b></div>
            <div><b>Species: <span id="speciesCount">0</span></b></div>
            <div><b>BINs: <span id="binCount">0</span></b></div>
            <div><b>Curated: <span id="curatedCount">0</span></b></div>
            <div><b>Uncurated: <span id="uncuratedCount">0</span></b></div>
            <div><b>BIN Sharing: <span id="binSharingEvents">0</span></b></div>
            <div><b>BIN Splitting: <span id="binSplittingEvents">0</span></b></div>            
        </div>      
        <div style="position: relative; margin-top: 20px;">
            <span style="cursor: pointer;" onclick="toggleInfo('columnsInfo')">❓</span>
            <div id="columnsInfo" style="display: none; background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong>How to use "Select Columns to Display":</strong>
                <ul>
                    <li>Check the boxes next to the column names you want to display in the table and press <b>Apply Filter</b> to refresh the HTML-table.</li>
                    <li>Unchecked columns will not be visible in the table.</li>
                    <li>The table dynamically updates to reflect the selected columns.</li>
                    <li>This feature allows you to customize the table view for better focus on relevant data.</li>
                </ul>
            </div>
        </div>
        <fieldset>
            <legend><b>Select Columns to Display:</b></legend>
            <div class="checkbox-group" id="checkboxGroup"></div>
        </fieldset>
        <div id="entriesContainer" style="margin-bottom: 10px;">
            <label for="entriesPerPage">Show entries:</label>
            <select id="entriesPerPage">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
        </div>
        <div id="recordsTable"></div>
        <button id="submitAllButton" onclick="submitAllRows()">Submit All on Page</button>
    </form>    
    <div id="errorMessage" class="error-message" style="display: none;"></div>
    <div id="successMessage" class="success-message" style="display: none;"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        fetch('/datasets')
            .then(response => response.json())
            .then(datasets => {
                const selector = document.getElementById('dataset-selector');
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset;
                    option.textContent = dataset;
                    selector.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching datasets:', error));
    });

    function switchDataset() {
        const selectedDataset = document.getElementById('dataset-selector').value;
        
        fetch('/switch-dataset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dataset: selectedDataset })
        })
        .then(response => response.text())
        .then(message => alert(message))
        .catch(error => console.error('Error switching dataset:', error));
    }    
        let changes = [];
        let statusSelections = {}; 
    document.addEventListener('DOMContentLoaded', async () => {
    function updateSearchTypeOptions() {
        const checkboxes = document.querySelectorAll('input[name="columns"]:checked');
        const selectedColumns = Array.from(checkboxes).map(cb => cb.value);

        const searchTypeDropdown = document.getElementById('searchType');
        const searchType2Dropdown = document.getElementById('searchType2');

        // Clear existing options
        searchTypeDropdown.innerHTML = '<option value=""></option>';
        searchType2Dropdown.innerHTML = '<option value=""></option>';

        // Populate new options
        selectedColumns.forEach(column => {
            const option = `<option value="${column}">${column}</option>`;
            searchTypeDropdown.innerHTML += option;
            searchType2Dropdown.innerHTML += option;
        });

        console.log('Updated dropdown options:', selectedColumns);
    }

    try {
        const response = await fetch('/columns');
        const data = await response.json();
        const checkboxGroup = document.getElementById('checkboxGroup');
        checkboxGroup.innerHTML = '<div class="checkbox-container"></div>';

        const container = checkboxGroup.querySelector('.checkbox-container');

        const columns = ['sampleid', 'bin_uri', 'processid', 'phylum', 'class', 'order', 'family', 'subfamily', 'genus', 'subspecies', 'species_reference', 'identification', 'identification_method', 'itentified_by', 'taxonomy_notes', 'sex', 'life_stages', 'notes', 'voucher_type', 'collectors', 'collection_date', 'collection_type', 'collection_notes', 'geoid', 'country_ocean', 'province', 'region', 'sector', 'site', 'site_code', 'coord', 'coord_source', 'elev', 'depth', 'nuc', 'nuc_basecount', 'recordset_code_arr', 'gb_acs', 'additionalStatus', 'url', 'ranking'];

        columns.forEach(column => {
            const isChecked = ['bin_uri', 'processid', 'identification', 'ranking', 'country_ocean', 'url', 'status'].includes(column) ? 'checked' : '';

            container.innerHTML += `
                <div class="checkbox-item">
                    <input type="checkbox" id="column${column}" name="columns" value="${column}" ${isChecked}>
                    <label for="column${column}">${column}</label>
                </div>
            `;
        });

        updateSearchTypeOptions();

        document.getElementById('checkboxGroup').addEventListener('change', updateSearchTypeOptions);

    } catch (error) {
        console.error('Error loading columns:', error);
    }

    // ✅ Function to fix duplicate "Ranking" column
    function updateTableHeaders() {
        const headers = document.querySelectorAll('#dataTable thead th');

        headers.forEach(th => {
            const text = th.textContent.trim().toLowerCase();

            if (text === 'ranking' && !th.querySelector('#rankingInfoIcon')) {
                th.innerHTML = `
                    <span style="display: inline-flex; align-items: center;">
                        Ranking 
                        <span 
                            id="rankingInfoIcon" 
                            style="color: red; cursor: pointer; margin-left: 5px;" 
                            onclick="openRankingInfo()">?</span> 
                    </span>
                `;
            }

            if (text === 'bags' && !th.querySelector('#bagsInfoIcon')) {
                th.innerHTML = `
                    <span style="display: inline-flex; align-items: center;">
                        BAGS 
                        <span 
                            id="bagsInfoIcon" 
                            style="color: red; cursor: pointer; margin-left: 5px;" 
                            onclick="openBAGSInfo()">?</span> 
                    </span>
                `;
            }
        });
    }    
    // ✅ Use MutationObserver to detect table changes
    const tableContainer = document.body; // Observe entire body since table is dynamically updated
    const observer = new MutationObserver((mutationsList, observer) => {
        for (let mutation of mutationsList) {
            if (mutation.type === 'childList') {
                const tableExists = document.querySelector('#dataTable');
                if (tableExists) {
                    updateTableHeaders();
                }
            }
        }
    });

    observer.observe(tableContainer, { childList: true, subtree: true });

});

    function handleSearchTypeChange(searchTypeId) {
        const searchTypeElement = document.getElementById(searchTypeId);
        const selectedColumn = searchTypeElement.value;
        const checkbox = document.getElementById(`column${selectedColumn}`);
        if (checkbox && !checkbox.checked) {
            checkbox.checked = true;
        }

        const table = document.getElementById('recordsTable');
        const thElements = table.querySelectorAll('th');
        const tdElements = table.querySelectorAll(`td[data-column="${selectedColumn}"]`);

        thElements.forEach(th => {
            if (th.dataset.column === selectedColumn) {
                th.style.display = '';
            }
        });
        tdElements.forEach(td => {
            td.style.display = '';
        });
    }

//Do not delete
let binUriColorMap = {}; // color map

function getRandomColor() {
    const r = Math.floor(Math.random() * 256);
    const g = Math.floor(Math.random() * 256);
    const b = Math.floor(Math.random() * 56); 
    return `rgb(${r}, ${g}, ${b})`;
}
function colorizeBinUriCells() {
    const table = $('#dataTable').DataTable().table().node();
    const rows = table.getElementsByTagName('tr');
    const binUriIndex = getColumnIndexByName('#dataTable', 'bin_uri');
    if (binUriIndex === -1) return; 

    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length > binUriIndex) {
            const cell = cells[binUriIndex];
            const binUriValue = cell.innerText.trim();      
            if (!binUriColorMap[binUriValue]) {
                binUriColorMap[binUriValue] = getRandomColor(); // check if color has already been used
            }

            // apply color
            cell.style.backgroundColor = binUriColorMap[binUriValue];
            cell.style.color = '#ffffff'; 
        }
    }
}

function applyStatusRowColoringAndExcludeRed() {
    const dataTable = $('#dataTable').DataTable();

    if (!dataTable) {
        console.error('DataTable is not initialized!');
        return;
    }

    const statusColumnIndex = getColumnIndexByName('#dataTable', 'status');
    const rankingColumnIndex = getColumnIndexByName('#dataTable', 'ranking');

    if (statusColumnIndex === -1) {
        console.error('Status column not found!');
        return;
    }
    if (rankingColumnIndex === -1) {
        console.error('Ranking column not found!');
        return;
    }

    // Use DataTables API to iterate through all visible rows across all pages
    dataTable.rows().every(function () {
        const row = this.node();
        const cells = row.getElementsByTagName('td');

        if (cells.length > Math.max(statusColumnIndex, rankingColumnIndex)) {
            const statusCell = cells[statusColumnIndex];
            const rankingCell = cells[rankingColumnIndex];

            // Get status from dropdown
            const dropdown = statusCell.querySelector('select');
            const statusValue = dropdown ? dropdown.value.trim().toLowerCase() : '';

            // Get ranking value (convert to number)
            const rankingValue = parseInt(rankingCell.textContent.trim(), 10);

            console.log('Processing Row:', row, 'Status:', statusValue || '<empty>', 'Ranking:', rankingValue);

            // Reset styles and visibility
            row.style.backgroundColor = '';
            row.style.color = '';
            row.style.display = ''; // Ensure all rows are visible by default

            // Apply light-grey background for ranking 1, 2, or 3
            if ([1, 2, 3].includes(rankingValue)) {
                row.style.backgroundColor = '#d6d6d6'; // Light-grey
            }

            // Override with status-based colors
            if (statusValue === 'valid record' || statusValue === 'reinclude species') {
                row.style.backgroundColor = '#d4edda'; // Green
                row.style.color = '#155724';
            } else if (statusValue === 'invalid record' || statusValue === 'exclude species') {
                row.style.backgroundColor = '#f8d7da'; // Red
                row.style.color = '#721c24';

                // Hide red rows if needed
                if (hideInvalidRecords) {
                    row.style.display = 'none';
                }
            }
        }
    });
}

let hideInvalidRecords = true; // Default to hiding invalid/excluded records

function toggleInvalidRecords() {
    hideInvalidRecords = !hideInvalidRecords;

    const button = document.getElementById('toggleInvalidButton');

    if (hideInvalidRecords) {
        button.textContent = "Show Invalid Records";
        button.classList.remove('hiding');
        button.classList.add('showing');
    } else {
        button.textContent = "Hide Invalid Records";
        button.classList.remove('showing');
        button.classList.add('hiding');
    }

    applyFilter();
}

document.getElementById('toggleInvalidRecords').addEventListener('click', async () => {
    hideInvalidRecords = !hideInvalidRecords;

    // Preserve active filters
    const searchTerm = document.getElementById('searchTerm').value;
    const searchType = document.getElementById('searchType').value;
    const searchTerm2 = document.getElementById('searchTerm2').value;
    const searchType2 = document.getElementById('searchType2').value;

    // Preserve current page before destroying the DataTable
    let currentPage = 0;
    if ($.fn.DataTable.isDataTable("#dataTable")) {
        currentPage = $('#dataTable').DataTable().page();
    }

    try {
        const response = await fetch('/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                searchTerm, 
                searchType, 
                searchTerm2, 
                searchType2, 
                columns: ['bin_uri', 'processid', 'identification', 'country_ocean', 'ranking'], // Ensure correct column order
                includeInvalid: !hideInvalidRecords 
            })  
        });

        if (!response.ok) throw new Error('Failed to fetch records');

        const data = await response.json();
        document.getElementById('recordsTable').innerHTML = data.table;

        // **Destroy old DataTable instance before reinitializing**
        if ($.fn.DataTable.isDataTable("#dataTable")) {
            $('#dataTable').DataTable().destroy();
        }

        // **Reinitialize DataTable and restore page number**
        const dataTable = $('#dataTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "drawCallback": function() {
                applyStatusRowColoringAndExcludeRed(); // Apply row coloring after rendering
                colorizeBinUriCells(); // Apply bin_uri coloring after rendering
            }
        });

        // Restore the previous page after table reload
        dataTable.page(currentPage).draw('page');

        // **Ensure button text reflects current state**
        document.getElementById('toggleInvalidRecords').textContent = hideInvalidRecords
            ? 'Show Invalid Records'
            : 'Hide Invalid Records';

        console.log(`Show/Hide Invalid clicked. Page restored to ${currentPage + 1}. Button state: ${hideInvalidRecords ? 'Show Invalid Records' : 'Hide Invalid Records'}`);

    } catch (error) {
        console.error('Error fetching records:', error);
    }
});

function getColumnIndexByName(table, columnName) {
    const headers = $(table).find('thead th');
    for (let i = 0; i < headers.length; i++) {
        if ($(headers[i]).text().trim().toLowerCase() === columnName.toLowerCase()) {
            return i;
        }
    }
    return -1; // if collumn is not available
}    
function initTableSort() {
    $.fn.dataTable.ext.order['dom-text'] = function(settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function(td) {
            const inputVal = $('input', td).val();
            console.log('Input Value:', inputVal); // Debugging: Wert der Texteingabe ausgeben
            return (inputVal || '').toLowerCase(); // Kleinbuchstaben für konsistente Sortierung
        });
    };
    $.fn.dataTable.ext.order['dom-select'] = function(settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function(td) {
            const selectVal = $('select', td).val();
            console.log('Select Value:', selectVal); // Debugging
            return (selectVal || '').toLowerCase(); 
        });
    };            
    const speciesIndex = getColumnIndexByName('#dataTable', 'Species');
    const statusIndex = getColumnIndexByName('#dataTable', 'Status');            
    const additionalStatusIndex = getColumnIndexByName('#dataTable', 'Additional Status');
    const curator_notesIndex = getColumnIndexByName('#dataTable', 'Curator Notes');
    
    $('#dataTable').DataTable({
        "columnDefs": [
            { "orderDataType": "dom-select", "targets": [statusIndex, additionalStatusIndex] },   // Dropdown-menue
            { "orderDataType": "dom-text", "targets": [speciesIndex, curator_notesIndex] },  
        ],
        "drawCallback": function(settings) {
            colorizeBinUriCells();                    
            applyStatusRowColoringAndExcludeRed();
        }
    });
}

function updateStats(json) {
    if (!json) return;

    if (document.getElementById('totalCount')) {
        document.getElementById('totalCount').innerText = json.recordsTotal ?? '0';
    }
    if (document.getElementById('recordCount')) {
        document.getElementById('recordCount').innerText = json.recordsFiltered ?? '0';
    }

    if (!json.stats) return;

    document.getElementById('speciesCount').innerText = json.stats.speciesCount;
    document.getElementById('binCount').innerText = json.stats.binCount;
    document.getElementById('curatedCount').innerText = json.stats.curatedCount;
    document.getElementById('uncuratedCount').innerText = json.stats.uncuratedCount;
    document.getElementById('binSharingEvents').innerText = json.stats.binSharingEvents;
    document.getElementById('binSplittingEvents').innerText = json.stats.binSplittingEvents;
    
}

function getRandomColor() {
    const r = Math.floor(Math.random() * 256);
    const g = Math.floor(Math.random() * 256);
    const b = Math.floor(Math.random() * 56);
    return `rgb(${r}, ${g}, ${b})`;
}

async function applyFilter() {
    const searchTerm = document.getElementById('searchTerm').value;
    const searchType = document.getElementById('searchType').value;
    const searchTerm2 = document.getElementById('searchTerm2').value;
    const searchType2 = document.getElementById('searchType2').value;

    let columns = Array.from(document.querySelectorAll('input[name="columns"]:checked')).map(cb => cb.value);

    if (columns.length === 0) {
        columns = ['bin_uri', 'processid', 'identification', 'country_ocean', 'url', 'ranking'];
    }

    const extraHeaders = ['BAGS', 'BIN Info', 'Status', 'Reason Name Correction', 'Correct Species Name', 'Curator Notes', 'Action'];
    const thead = `<thead><tr>${columns.map(col => `<th>${col}</th>`).join('')}${extraHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
    document.getElementById('recordsTable').innerHTML = `<table id="dataTable">${thead}<tbody></tbody></table>`;

    if ($.fn.DataTable.isDataTable("#dataTable")) {
        $('#dataTable').DataTable().destroy();
    }

    const entriesPerPage = parseInt(document.getElementById('entriesPerPage').value, 10) || 10;

    const defaultOrder = [];

    if (columns.includes('bin_uri')) {
        defaultOrder.push([columns.indexOf('bin_uri'), 'asc']);
    }
    if (columns.includes('identification')) {
        defaultOrder.push([columns.indexOf('identification'), 'asc']);
    }

    $('#dataTable').DataTable({
        serverSide: true,
        processing: true,
        ordering: true,
        order: defaultOrder,       
        pageLength: entriesPerPage, // ✅ key line
        lengthChange: false, // ✅ Prevent default dropdown from appearing
        ajax: {
            url: '/generate',
            type: 'POST',
            contentType: 'application/json',
            data: function (d) {                                
                return JSON.stringify({
                    start: d.start,
                    length: d.length,
                    searchTerm,
                    searchType,
                    searchTerm2,
                    searchType2,
                    columns,
                    includeInvalid: !hideInvalidRecords,
                    draw: d.draw,
                    order: d.order
                });
            }
        },
        paging: true,
        ordering: true,
        searching: false,
        info: true,
        drawCallback: function(settings) {
            updateStats(settings.json);  // Update your statistics box after data loads
        },
        createdRow: function(row, data, dataIndex) {
            const binUri = data[columns.indexOf('bin_uri')];
            const statusValue = data[columns.length + 2];
            const reasonValue = data[columns.length + 3];
            const speciesValue = data[columns.length + 4];
            const notesValue = data[columns.length + 5];
            const processId = data[columns.length + 6];
            const rankingIndex = columns.indexOf('ranking');
            const rankingValue = rankingIndex !== -1 ? parseInt(data[rankingIndex], 10) : NaN;
            const urlIndex = columns.indexOf('url');
            if (urlIndex !== -1) {
                const rawUrl = data[urlIndex];
                if (rawUrl) {
                    $('td', row).eq(urlIndex).html(`<a href="${rawUrl}" target="_blank">Link</a>`);
                }
            }

            $('td', row).eq(columns.length + 2).html(`
                <select>
                    <option value="" ${statusValue === '' ? 'selected' : ''}></option>
                    <option value="valid record" ${statusValue === 'valid record' ? 'selected' : ''}>valid record</option>
                    <option value="invalid record" ${statusValue === 'invalid record' ? 'selected' : ''}>invalid record</option>
                    <option value="exclude species" ${statusValue === 'exclude species' ? 'selected' : ''}>exclude species</option>
                    <option value="reinclude species" ${statusValue === 'reinclude species' ? 'selected' : ''}>reinclude species</option>
                </select>`);

            $('td', row).eq(columns.length + 3).html(`
                <select>
                    <option value="" ${reasonValue === '' ? 'selected' : ''}></option>
                    <option value="misidentified" ${reasonValue === 'misidentified' ? 'selected' : ''}>misidentified</option>
                    <option value="synonym" ${reasonValue === 'synonym' ? 'selected' : ''}>synonym</option>
                    <option value="typo" ${reasonValue === 'typo' ? 'selected' : ''}>typo</option>
                </select>`);

            $('td', row).eq(columns.length + 4).html(`<input type="text" value="${speciesValue}">`);
            $('td', row).eq(columns.length + 5).html(`<input type="text" value="${notesValue}">`);
            $('td', row).eq(columns.length + 6).html(`<button class="row-submit-button" onclick="submitRow(event, null, '${processId}')">Submit</button>`);

            if (columns.indexOf('bin_uri') !== -1 && binUri) {
                if (!binUriColorMap[binUri]) {
                    binUriColorMap[binUri] = getRandomColor();
                }
                $('td', row).eq(columns.indexOf('bin_uri')).css({
                    backgroundColor: binUriColorMap[binUri],
                    color: '#ffffff'
                });
            }

            if (!isNaN(rankingValue) && rankingValue >= 1 && rankingValue <= 3) {
                $(row).css({ backgroundColor: '#d6d6d6', color: '' });
            }

            // Status overrides — always applied after ranking
            if (statusValue.toLowerCase() === 'valid record' || statusValue.toLowerCase() === 'reinclude species') {
                $(row).css({ backgroundColor: '#d4edda', color: '#155724' });
            } else if (statusValue.toLowerCase() === 'invalid record' || statusValue.toLowerCase() === 'exclude species') {
                $(row).css({ backgroundColor: '#f8d7da', color: '#721c24' });
            }
        }
    });
}

async function updateDistinctValues(column, searchTerm, searchType, searchTerm2, searchType2) {
    try {
        const response = await fetch('/distinct-values', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ column, searchTerm, searchType, searchTerm2, searchType2 })
        });

        const data = await response.json();

        if (data.success) {
            // Assume data contains counts for records, species, and BINs
            const recordCount = data.recordCount || 0;
            const speciesCount = data.speciesCount || 0;
            const binCount = data.binCount || 0;
            const curatedCount = data.curatedCount || 0;
            const uncuratedCount = data.uncuratedCount || 0;
            const binSharingEvents = data.binSharingEvents || 0;
            const binSplittingEvents = data.binSplittingEvents || 0;

            // Update the statistics field
            const statisticsText = `${recordCount} total records, ${curatedCount} curated records, ${uncuratedCount} uncurated records, ${speciesCount} species, ${binCount} BINs, ${binSharingEvents} BIN-sharing events, and ${binSplittingEvents} BIN-splitting events.`;
            document.getElementById('statisticsText').innerText = statisticsText;
        } else {
            document.getElementById('statisticsText').innerText = 'Error fetching data.';
        }
    } catch (error) {
        console.error('Error fetching distinct values:', error);
        document.getElementById('statisticsText').innerText = 'Error fetching data.';
    }
}
        function addChangeListeners() {
            document.querySelectorAll('#dataTable select, #dataTable input[type="text"]').forEach(element => {
                element.addEventListener('change', (event) => {
                    const index = event.target.parentNode.parentNode.rowIndex - 1;
                    const column = event.target.id.split('-')[0];
                    const newValue = event.target.value;

                    if (column === 'status') {
                        const processId = document.getElementById(`processid-${index}`).textContent;
                        statusSelections[processId] = newValue;
                    }

                    const existingChange = changes.find(change => change.index === index && change.column === column);
                    if (existingChange) {
                        existingChange.newValue = newValue;
                    } else {
                        changes.push({ index, column: column, newValue });
                    }
                });
            });
        }
        function loadStatusSelections() {
            document.querySelectorAll('#dataTable select[name="status"]').forEach((element, index) => {
                const processId = document.getElementById(`processid-${index}`).textContent;
                if (statusSelections[processId]) {
                    element.value = statusSelections[processId];
                }
            });
        }
        // Function to submit single row
        async function submitRow(event, index, processId) {
            if (event) event.preventDefault();

            let row;
            if (event) {
                row = event.target.closest('tr');
            } else if (typeof index === 'number') {
                const table = $('#dataTable').DataTable();
                row = table.row(index).node();
            } else {
                console.error("submitRow: No valid event or index provided.");
                return;
            }

            const status = row.querySelector('td:nth-child(9) select').value;
            const additionalStatus = row.querySelector('td:nth-child(10) select').value;
            const species = row.querySelector('td:nth-child(11) input').value;
            const curator_notes = row.querySelector('td:nth-child(12) input').value;

            if (status === 'exclude species') {
                const userConfirmed = confirm("You are about to exclude an entire species. Are you sure?");
                if (!userConfirmed) return;
            } else if (status === 'reinclude species') {
                const userConfirmed = confirm("You are about to reinclude an entire species. Are you sure?");
                if (!userConfirmed) return;
            }

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ processId, status, additionalStatus, species, curator_notes })
                });

                if (!response.ok) throw new Error('Failed to submit row');

                showMessage('success', 'Submit successful');

            } catch (error) {
                showMessage('error', 'Submit failed');
                console.error(error);
            }
        }

        function submitAllRows() {
            const table = $('#dataTable').DataTable();
            table.rows({ page: 'current' }).every(function(index) {
                const row = this.node();
                const processId = row.querySelector('td:nth-child(13) button').getAttribute('onclick').split("'")[1];
                submitRow(undefined, index, processId);
            });
        }

        function showMessage(type, message) {
            const messageElement = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');

            messageElement.innerText = message;
            messageElement.style.display = "block";

            setTimeout(() => {
                messageElement.style.display = "none";
            }, 3000);
        }        
        function openRankingInfo() {
            const popup = window.open("", "RankingInfo", "width=600,height=400,resizable=yes");
            if (popup) {
                popup.document.write(`
                    <html>
                        <head>
                            <title>Ranking Information</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    height: 100%;
                                    background-color: #f9f9f9;
                                    font-family: Arial, sans-serif;
                                }
                                img {
                                    max-width: 100%;
                                    max-height: 100%;
                                    border-radius: 10px;
                                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                                }
                            </style>
                        </head>
                        <body>
                            <img src="ressources/Ranking.jpg" alt="Ranking Explanation">
                        </body>
                    </html>
                `);
            } else {
                alert("Popup blocked. Please allow popups for this website.");
            }
        }
        function openBAGSInfo() {
            const popup = window.open("", "BAGS_Info", "width=600,height=400,resizable=yes");
            if (popup) {
                popup.document.write(`
                    <html>
                        <head>
                            <title>BAGS Information</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    height: 100%;
                                    background-color: #f9f9f9;
                                    font-family: Arial, sans-serif;
                                }
                                img {
                                    max-width: 100%;
                                    max-height: 100%;
                                    border-radius: 10px;
                                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                                }
                            </style>
                        </head>
                        <body>
                            <img src="ressources/BAGS.jpg" alt="BAGS Explanation">
                        </body>
                    </html>
                `);
            } else {
                alert("Popup blocked. Please allow popups for this website.");
            }
        }
        async function stopServer() {
            try {
                const response = await fetch('/stopServer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to stop server');
                }
                document.getElementById('successMessage').innerText = 'Server stopped successfully';
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error stopping server:', error);
                document.getElementById('errorMessage').innerText = 'Failed to stop server';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>
